server {
    listen 80;
    server_name hosting-pc.tail013787.ts.net;

    # Proxy CMS requests to Django - this needs to be before generic location block
    location /cms/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy Django admin requests to Django
    location /django-admin/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy admin requests to Django (for backwards compatibility)
    location /admin/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy API requests to Django
    location /api/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy authentication requests to Django
    location /auth/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy documents requests to Django
    location /documents/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy Wagtail images requests to Django (for image serving)
    # This handles Wagtail's image serve URLs like /cms/images/3/
    location ~ ^/cms/images/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy Wagtail documents requests to Django
    location ~ ^/cms/documents/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve user-uploaded media files (images, documents, etc.)
    # This must come BEFORE more generic location blocks
    location /media/ {
        alias /app/media/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        
        # Handle image files with proper MIME types
        location ~* \.(jpg|jpeg|gif|png|webp|avif|tiff)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Proxy analytics requests to Django
    location /analytics/ {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Serve Django admin static files (CSS, JS, images for admin)
    location /static/admin/ {
        alias /app/staticfiles/admin/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve Wagtail admin static files (CSS, JS, images for Wagtail admin)
    location /static/wagtailadmin/ {
        alias /app/staticfiles/wagtailadmin/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve Wagtail documents static files
    location /static/wagtaildocs/ {
        alias /app/staticfiles/wagtaildocs/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve Wagtail images static files
    location /static/wagtailimages/ {
        alias /app/staticfiles/wagtailimages/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve Django static files (CSS, JS, images for admin/CMS)
    location /staticfiles/ {
        alias /app/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve React static assets (JS, CSS, images for frontend)
    location /static/ {
        root /app/build;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Serve frontend build files - this should come last
    location / {
        root /app/build;
        try_files $uri $uri/ /index.html;
    }
}